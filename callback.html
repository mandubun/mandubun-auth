<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Mandubun Login</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        padding: 24px;
        max-width: 520px;
        margin: auto;
      }
      code {
        word-break: break-all;
      }
    </style>
  </head>
  <body>
    <h2 id="title">Logging you inâ€¦</h2>
    <p id="status">Please wait.</p>

    <script>
      // ðŸ” Chrome extension IDs â€” try production first, then dev
      const EXTENSION_IDS = [
        "hjnmpogajhamijdcdglgppmjkcplinel",  // production (Chrome Web Store)
        "hpnbmbgkgdohhehnjjnbabjlnakcioad",  // dev (unpacked)
      ];

      function getParams() {
        const hash = window.location.hash.startsWith("#")
          ? window.location.hash.slice(1)
          : "";
        const params = new URLSearchParams(hash);
        return {
          access_token: params.get("access_token"),
          refresh_token: params.get("refresh_token"),
          expires_at: params.get("expires_at"),
        };
      }

      function trySendToken(ids, payload, index) {
        if (index >= ids.length) {
          document.getElementById("title").textContent = "Login failed";
          document.getElementById("status").textContent =
            "Extension not reachable. Make sure Mandubun is installed and enabled.";
          return;
        }

        chrome.runtime.sendMessage(ids[index], payload, () => {
          if (chrome.runtime.lastError) {
            // This ID didn't work â€” try the next one
            trySendToken(ids, payload, index + 1);
            return;
          }

          document.getElementById("title").textContent = "Logged in âœ…";
          document.getElementById("status").textContent =
            "Taking you to Naver Webtoonsâ€¦";

          setTimeout(() => {
            window.close();
            // If window.close() was blocked by browser, show fallback message
            document.getElementById("status").textContent =
              "You can close this tab â€” Mandubun is ready on Naver Webtoons.";
          }, 1500);
        });
      }

      function sendToken() {
        const { access_token, refresh_token, expires_at } = getParams();

        if (!access_token) {
          document.getElementById("title").textContent = "Login failed";
          document.getElementById("status").textContent =
            "No token found. Please request a new magic link.";
          return;
        }

        trySendToken(EXTENSION_IDS, {
          type: "SUPABASE_TOKEN",
          access_token,
          refresh_token,
          expires_at,
        }, 0);
      }

      sendToken();
    </script>
  </body>
</html>
