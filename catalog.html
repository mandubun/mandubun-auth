<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mandubun Catalog</title>
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        max-width: 980px;
        margin: 20px auto;
        padding: 0 16px;
      }
      h1 { margin: 8px 0 16px; }
      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 14px;
      }
      input, button {
        padding: 10px 12px;
        font-size: 14px;
        border: 1px solid #ddd;
        border-radius: 10px;
      }
      button { cursor: pointer; background: #111; color: #fff; border-color: #111; }
      button:disabled { opacity: 0.6; cursor: default; }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 12px;
      }
      .card {
        border: 1px solid #eee;
        border-radius: 14px;
        padding: 12px;
        background: #fff;
      }
      .thumb {
        width: 100%;
        aspect-ratio: 16/9;
        object-fit: cover;
        border-radius: 12px;
        background: #f2f2f2;
      }
      .title { font-weight: 700; margin-top: 10px; }
      .meta { color: #666; font-size: 13px; margin-top: 4px; }
      .episodes a { display:block; padding: 4px 0; text-decoration: none; color: #111; }
      .episodes a:hover { text-decoration: underline; }
      #status { margin: 10px 0; color: #666; }
    </style>
  </head>

  <body>
    <h1>Catalog</h1>

    <!-- ✅ These IDs are REQUIRED because your script looks them up -->
    <div class="row">
      <input id="q" placeholder="Search title…" />
      <input id="genre" placeholder="Genre (optional)" />
      <input id="day" placeholder="Update day (optional)" />
      <button id="go">Search</button>
    </div>

    <div id="status"></div>
    <div class="grid" id="grid"></div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const API = "https://api.mandubun.com";

        const els = {
          q: document.getElementById("q"),
          genre: document.getElementById("genre"),
          day: document.getElementById("day"),
          go: document.getElementById("go"),
          status: document.getElementById("status"),
          grid: document.getElementById("grid"),
        };

        // ✅ Fail loudly if core containers are missing
        if (!els.status || !els.grid) {
          console.error("Catalog page is missing #status or #grid. Check your HTML IDs.");
          return;
        }

        // Cache episodes so expanding/collapsing is instant
        const episodeCache = new Map(); // webtoon_id -> episode[]

        function escapeHtml(s) {
          return String(s || "").replace(/[&<>"']/g, (c) => ({
            "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
          }[c]));
        }

        async function fetchJSON(url) {
          const res = await fetch(url);
          if (!res.ok) throw new Error(`${res.status} ${await res.text().catch(()=>"")}`);
          return await res.json();
        }

        // ✅ Try multiple endpoint paths until one works
        async function fetchJSONWithFallback(paths) {
          let lastErr = null;
        
          for (const p of paths) {
            try {
              const result = await fetchJSON(`${API}${p}`);
              console.log("✅ Catalog endpoint OK:", `${API}${p}`);
              return result;
            } catch (e) {
              lastErr = e;
            }
          }
        
          throw lastErr || new Error("All endpoints failed");
        }
        
        async function loadSeries() {
          const q = (els.q?.value || "").trim();
          const genre = (els.genre?.value || "").trim();
          const day = (els.day?.value || "").trim();

          const params = new URLSearchParams();
          if (q) params.set("q", q);
          if (genre) params.set("genre", genre);
          if (day) params.set("day", day);
          params.set("limit", "60");

          els.status.textContent = "Loading series…";
          els.grid.innerHTML = "";

          let data;
          try {
            data = await fetchJSONWithFallback([
              `/catalog/series?${params.toString()}`,
              `/panel/catalog/series?${params.toString()}`
            ]);
          } catch (e) {
            console.error("❌ Catalog failed:", e);
            els.status.textContent = `Catalog failed: ${e?.message || e}`;
            return;
          }
          
          els.status.textContent = `${data.items.length} series`;

          for (const s of data.items) {
            const card = document.createElement("div");
            card.className = "card";

            const wid = s.webtoon_id;
            const title = escapeHtml(s.series_title || "(untitled)");
            const thumb = escapeHtml(s.thumbnail_url || "");
            const meta = `${s.episode_count || 0} processed episodes • ${s.panel_count || 0} panels`;

            card.innerHTML = `
              <img class="thumb" src="${thumb}" alt="thumbnail" />
              <div class="title">${title}</div>
              <div class="meta">${escapeHtml(s.genre || "")} ${escapeHtml(s.update_day || "")}</div>
              <div class="meta">${meta}</div>
              <button class="btn" data-action="toggle" data-webtoon-id="${wid}">Show episodes</button>
              <div class="episodes" data-episodes="${wid}" style="display:none; margin-top:10px;"></div>
            `;

            card.querySelector('[data-action="toggle"]').onclick = async (e) => {
              const btn = e.currentTarget;
              const webtoonId = btn.getAttribute("data-webtoon-id");
              const epBox = card.querySelector(`[data-episodes="${webtoonId}"]`);

              const isOpen = epBox.style.display !== "none";
              if (isOpen) {
                epBox.style.display = "none";
                btn.textContent = "Show episodes";
                return;
              }

              btn.disabled = true;
              btn.textContent = "Loading…";

              try {
                const episodes = await loadEpisodes(webtoonId);
                epBox.innerHTML = renderEpisodesList(episodes);
                epBox.style.display = "block";
                btn.textContent = "Hide episodes";
              } catch (err) {
                epBox.innerHTML = `<div class="meta">Failed to load episodes: ${escapeHtml(err.message)}</div>`;
                epBox.style.display = "block";
                btn.textContent = "Show episodes";
              } finally {
                btn.disabled = false;
              }
            };

            els.grid.appendChild(card);
          }
        }

        async function loadEpisodes(webtoonId) {
          if (episodeCache.has(webtoonId)) return episodeCache.get(webtoonId);

          const data = await fetchJSONWithFallback([
            `/catalog/episodes?webtoon_id=${encodeURIComponent(webtoonId)}&limit=300`,
            `/panel/catalog/episodes?webtoon_id=${encodeURIComponent(webtoonId)}&limit=300`
          ]);
          const episodes = data.items || [];
          episodeCache.set(webtoonId, episodes);
          return episodes;
        }

        function renderEpisodesList(episodes) {
          if (!episodes.length) return `<div class="meta">No processed episodes yet.</div>`;

          const sorted = [...episodes].sort((a, b) => {
            const ai = parseInt(a.episode_id, 10);
            const bi = parseInt(b.episode_id, 10);
            if (!Number.isNaN(ai) && !Number.isNaN(bi)) return ai - bi;
            return String(a.episode_id).localeCompare(String(b.episode_id));
          });

          return `
            <div style="display:flex; flex-direction:column; gap:6px;">
              ${sorted.map(ep => `
                <a href="${escapeHtml(ep.url)}" target="_blank">
                  Episode ${escapeHtml(ep.episode_id)} — ${escapeHtml(ep.episode_title || "")}
                  <span style="opacity:.65;">(panels: ${ep.panel_count || 0})</span>
                </a>
              `).join("")}
            </div>
          `;
        }

        if (els.go) els.go.onclick = () => loadSeries();
        loadSeries();
      });
    </script>
  </body>
</html>
